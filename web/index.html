<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WarehouseControl UI</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    header { display:flex; align-items:center; gap:12px; }
    input, select, button { padding:6px 8px; font-size:14px; }
    button { cursor: pointer; }
    section { margin-top: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f3f3f3; text-align: left; }
    .row { display:flex; gap:8px; flex-wrap: wrap; }
    .card { border:1px solid #ddd; padding:12px; border-radius:6px; }
    .muted { color:#666; }
    .error { color:#b00020; }
    .success { color:#0a7a0a; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
  </style>
</head>
<body>
  <header>
    <h1>WarehouseControl</h1>
    <span class="muted">Мини UI к API</span>
  </header>

  <section class="card">
    <h2>Аутентификация</h2>
    <div class="row">
      <label>Логин <input id="login" placeholder="admin" /></label>
      <label>Пароль <input id="password" type="password" placeholder="admin" /></label>
      <label>Роль
        <select id="role">
          <option value="admin">admin</option>
          <option value="manager">manager</option>
          <option value="viewer">viewer</option>
        </select>
      </label>
      <button id="btnLogin">Войти</button>
      <button id="btnRegister">Регистрация</button>
    </div>
    <div class="row">
      <span class="muted">Токен:</span>
      <code id="token" style="max-width:70%; overflow:auto; display:inline-block"></code>
    </div>
    <div id="authMsg"></div>
  </section>

  <section class="grid">
    <div class="card">
      <h2>Товары</h2>
      <div class="row">
        <button id="btnLoadItems">Загрузить</button>
      </div>
      <div class="row">
        <label>Название <input id="newItemName" placeholder="Например: Яблоки" /></label>
        <label>Количество <input id="newItemCount" type="number" min="0" value="0" /></label>
        <label>Цена <input id="newItemPrice" type="number" step="0.01" min="0.01" value="1.00" /></label>
        <button id="btnCreateItem">Создать</button>
      </div>
      <table>
        <thead>
          <tr><th>ID</th><th>Название</th><th>Количество</th><th>Цена</th><th>Действия</th></tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
    </div>

    <div class="card">
      <h2>История</h2>
      <div class="row">
        <label>from <input id="histFrom" type="date" /></label>
        <label>to <input id="histTo" type="date" /></label>
        <label>item_id <input id="histItemId" placeholder="UUID (опц.)" /></label>
        <label>action
          <select id="histAction">
            <option value="">(любое)</option>
            <option value="created">created</option>
            <option value="updated">updated</option>
            <option value="deleted">deleted</option>
          </select>
        </label>
        <label>login <input id="histLogin" placeholder="поиск по логину" /></label>
        <button id="btnLoadHistory">Загрузить</button>
        <button id="btnExportCSV">CSV</button>
      </div>
      <table>
        <thead>
          <tr><th>#</th><th>ItemID</th><th>Action</th><th>ChangedBy</th><th>Login</th><th>At</th><th>Old</th><th>New</th><th>Diff</th></tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
  </section>

  <script>
    const API = `http://localhost:8080`;
    let accessToken = '';

    function setMsg(el, msg, kind='') {
      el.className = kind;
      el.textContent = msg || '';
    }
    function formatLocal(iso) {
        if (!iso) return '';
        const d = new Date(iso); // парсинг UTC
        return d.toLocaleString(); // локальное время по настройкам пользователя
    }

    async function api(path, opts={}) {
      const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
      if (accessToken) headers['Authorization'] = `Bearer ${accessToken}`;
      const res = await fetch(`${API}${path}`, { ...opts, headers });
      const ct = res.headers.get('content-type') || '';
      const isJson = ct.includes('application/json');
      const body = isJson ? await res.json() : await res.text();
      if (!res.ok) {
        throw new Error(isJson ? (body.error || JSON.stringify(body)) : body);
      }
      return body;
    }

    // Auth
    document.getElementById('btnLogin').addEventListener('click', async () => {
      const login = document.getElementById('login').value.trim();
      const password = document.getElementById('password').value;
      const msg = document.getElementById('authMsg');
      try {
        const data = await api('/api/auth/login', { method:'POST', body: JSON.stringify({ login, password }) });
        // API returns snake_case fields per dto.JWTResponse
        accessToken = data.access_token || data.accessToken || '';
        document.getElementById('token').textContent = accessToken;
        setMsg(msg, 'Вход выполнен', 'success');
      } catch (e) {
        setMsg(msg, `Ошибка входа: ${e.message}`, 'error');
      }
    });

    document.getElementById('btnRegister').addEventListener('click', async () => {
      const login = document.getElementById('login').value.trim();
      const password = document.getElementById('password').value;
      const role = document.getElementById('role').value;
      const msg = document.getElementById('authMsg');
      try {
        const data = await api('/api/auth/register', { method:'POST', body: JSON.stringify({ login, password, role }) });
        setMsg(msg, `Зарегистрирован: ${data.login}`, 'success');
      } catch (e) {
        setMsg(msg, `Ошибка регистрации: ${e.message}`, 'error');
      }
    });

    // Items
    document.getElementById('btnLoadItems').addEventListener('click', async () => {
      const bodyEl = document.getElementById('itemsBody');
      bodyEl.innerHTML = '';
      try {
        const items = await api('/api/items');
        if (!Array.isArray(items)) {
            bodyEl.innerHTML = '<tr><td colspan="5" class="muted">Нет данных</td></tr>';
            return;
        }
        for (const it of items) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${it.id}</td>
            <td>${escapeHtml(it.name)}</td>
            <td>${it.count}</td>
            <td>${it.price}</td>
            <td>
              <button data-id="${it.id}" class="btnEdit">Редактировать</button>
              <button data-id="${it.id}" class="btnDelete">Удалить</button>
            </td>`;
          bodyEl.appendChild(tr);
        }
        attachItemActions();
      } catch (e) {
        bodyEl.innerHTML = `<tr><td colspan="5" class="error">${escapeHtml(e.message)}</td></tr>`;
      }
    });

    document.getElementById('btnCreateItem').addEventListener('click', async () => {
      const name = document.getElementById('newItemName').value.trim();
      const count = parseInt(document.getElementById('newItemCount').value || '0', 10);
      const price = parseFloat(document.getElementById('newItemPrice').value || '0');
      if (!name) { alert('Название обязательно'); return; }
      if (!(price > 0)) { alert('Цена должна быть > 0'); return; }
      try {
        await api('/api/items', { method:'POST', body: JSON.stringify({ name, count, price }) });
        document.getElementById('btnLoadItems').click();
      } catch (e) {
        alert('Ошибка создания: ' + e.message);
      }
    });

    function attachItemActions() {
      document.querySelectorAll('.btnEdit').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          try {
            const row = btn.closest('tr');
            const currentName = row.children[1].textContent;
            const currentCount = row.children[2].textContent;
            const currentPrice = row.children[3].textContent;

            const name = prompt('Название:', currentName);
            if (name === null) return;
            const countStr = prompt('Количество:', currentCount);
            if (countStr === null) return;
            const priceStr = prompt('Цена:', currentPrice);
            if (priceStr === null) return;

            const count = parseInt(countStr, 10);
            const price = parseFloat(priceStr);
            if (!name.trim()) { alert('Название обязательно'); return; }
            if (!(price > 0)) { alert('Цена должна быть > 0'); return; }

            await api(`/api/items/${id}`, { method:'PUT', body: JSON.stringify({ name: name.trim(), count, price }) });
            document.getElementById('btnLoadItems').click();
          } catch (e) {
            alert('Ошибка обновления: ' + e.message);
          }
        });
      });

      document.querySelectorAll('.btnDelete').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          if (!confirm('Удалить товар?')) return;
          try {
            await api(`/api/items/${id}`, { method:'DELETE' });
            document.getElementById('btnLoadItems').click();
          } catch (e) {
            alert('Ошибка удаления: ' + e.message);
          }
        });
      });
    }

    // History
    document.getElementById('btnLoadHistory').addEventListener('click', async () => {
      const bodyEl = document.getElementById('historyBody');
      bodyEl.innerHTML = '';
      const from = document.getElementById('histFrom').value;
      const to = document.getElementById('histTo').value;
      const id = document.getElementById('histItemId').value.trim();
      const action = document.getElementById('histAction').value;
      const login = document.getElementById('histLogin').value.trim();
      if (!from || !to) {
        bodyEl.innerHTML = `<tr><td colspan="8" class="error">Укажите from/to даты</td></tr>`;
        return;
      }
      try {
        const q = new URLSearchParams({ from, to });
        if (id) q.set('id', id);
        if (action) q.set('action', action);
        if (login) q.set('login', login);
        const list = await api(`/api/history?${q.toString()}`);
        let idx = 1;
        for (const h of list) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${idx++}</td>
            <td>${h.item_id}</td>
            <td>${h.action}</td>
            <td>${h.changed_by}</td>
            <td>${escapeHtml(h.changed_by_login || '')}</td>
            <td>${formatLocal(h.changed_at)}</td>
            <td><pre>${escapeHtml(JSON.stringify(h.old_item_snapshot || {}, null, 2))}</pre></td>
            <td><pre>${escapeHtml(JSON.stringify(h.new_item_snapshot || {}, null, 2))}</pre></td>
            <td>${renderDiff(h.item_diff)}</td>
          `;
          bodyEl.appendChild(tr);
        }
      } catch (e) {
        bodyEl.innerHTML = `<tr><td colspan="8" class="error">${escapeHtml(e.message)}</td></tr>`;
      }
    });

    // Export history to CSV
    document.getElementById('btnExportCSV').addEventListener('click', async () => {
      const from = document.getElementById('histFrom').value;
      const to = document.getElementById('histTo').value;
      const id = document.getElementById('histItemId').value.trim();
      const action = document.getElementById('histAction').value;
      const login = document.getElementById('histLogin').value.trim();
      if (!from || !to) {
        alert('Укажите from/to даты');
        return;
      }
      try {
        const q = new URLSearchParams({ from, to });
        if (id) q.set('id', id);
        if (action) q.set('action', action);
        if (login) q.set('login', login);
        const headers = { 'Accept': 'text/csv' };
        if (accessToken) headers['Authorization'] = `Bearer ${accessToken}`;
        const resp = await fetch(`${API}/api/history/csv?${q.toString()}`, { headers });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(text || `HTTP ${resp.status}`);
        }
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g, '-');
        a.download = `history-${ts}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert('Ошибка экспорта CSV: ' + e.message);
      }
    });

    function renderDiff(d) {
      if (!d) return '<span class="muted">—</span>';
      if (Array.isArray(d.diffs)) {
        if (d.diffs.length === 0) return '<span class="muted">—</span>';
        const items = d.diffs.map(x => `${escapeHtml(x.field)}: ${escapeHtml(JSON.stringify(x.from))} → ${escapeHtml(JSON.stringify(x.to))}`);
        return `<ul><li>${items.join('</li><li>')}</li></ul>`;
      }
      const fields = ['name','count','price'];
      const lines = [];
      for (const f of fields) {
        if (d[f] && (d[f].old !== undefined || d[f].new !== undefined)) {
          lines.push(`${escapeHtml(f)}: ${escapeHtml(JSON.stringify(d[f].old))} → ${escapeHtml(JSON.stringify(d[f].new))}`);
        }
      }
      if (lines.length === 0) return '<span class="muted">—</span>';
      return `<ul><li>${lines.join('</li><li>')}</li></ul>`;
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;');
    }
  </script>
</body>
</html>
